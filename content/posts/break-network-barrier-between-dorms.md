+++
title = "打通和朋友宿舍间的网段"
date = "2023-12-02T17:23:53+08:00"
tags = ["Networking", "Random Stuff"]
keywords = ["Wireguard", "OpenWRT", "Networking"]
description = "我想随时都能访问朋友宿舍的NAS，所以我打通了我们的网段。"
showFullContent = false
draft = true
+++

## 0x00 前言

### 干啥呢

我和朋友的宿舍里都有`路由器`，都开启了`NAT`，所以我们的网段是隔离的。

*不过`路由器`都是为了`多播`而存在的 （x*

朋友在他宿舍里放了个台式机，跑的是`TrueNAS` ~~(富哥)~~。他的`NAS`上面有一些虚拟机，我想直接访问它们。

### 一点别的事情

说来，上学期我测试的时候，宿舍楼的校园网是无法相互访问的，估计是开了`AP Isolation`啥的。不过这个学期突然又可以了，挺好的。

这个方案其实一开始我是使用`n2n`，通过自建的`n2n Supernode`进行打洞、通讯的。不过`n2n`似乎只能跑到`100Mbps`。我们的校园网接入是`100Mbps`，我猜测咱的`edge`节点走校园网的出口进行通讯了，而不是直接在校园网网段内通讯，所以速度很慢。

反正挺神奇的。

## 0x01 实现

### DDNS 以及一些别的

我需要知道对方宿舍路由器的`IP`地址。
这应该是很简单的事情，直接用`DDNS`就好了，我用的是`ddns-go`。

后来我尝试在本地解析对方的`IP`地址，却发现怎么查也查不出来。我还以为是解析没那么快，后来调查了一下才发现有个东西叫`重绑定保护`，在`OpenWrt`中是默认启用的，它会`丢弃包含 RFC1918 地址的上游响应`，也就是会丢弃掉DNS查询返回中的`私有地址`。

> RFC1918 你可以看 [这里](https://datatracker.ietf.org/doc/html/rfc1918)。在互联网的地址架构中，专用网络是指遵守RFC 1918和RFC 4193规范，使用专用IP地址空间的网络。私有IP无法直接连接互联网，需要使用网络地址转换或者代理服务器来实现。与公网IP相比，私有IP是免费的，同时节省了IP地址资源，适合在局域网使用。(来自[Wikipedia](https://zh.wikipedia.org/zh-cn/%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9C))

这个东西是为了防止`DNS重绑定攻击`的。基本上就是，保护你的内网设备不被恶意网页访问到。如果你
感兴趣，你可以读读下面的内容：

> DNS重新绑定是计算机攻击的一种形式。 在这种攻击中，恶意网页会导致访问者运行客户端脚本，攻击网络上其他地方的计算机。 从理论上讲，同源策略可防止发生这种情况：客户端脚本只能访问为脚本提供服务的同一主机上的内容。 比较域名是实施此策略的重要部分，因此DNS重新绑定通过滥用域名系统（DNS）来绕过这种保护。
这种攻击可以通过让受害者的网络浏览器访问专用IP地址的机器并将结果返回给攻击者来破坏专用网络。 它也可以用于使用受害者机器发送垃圾邮件，分布式拒绝服务攻击或其他恶意活动。
(来自[Wikipedia](https://zh.wikipedia.org/wiki/DNS%E9%87%8D%E6%96%B0%E7%BB%91%E5%AE%9A%E6%94%BB%E5%87%BB))

解决方法就是，去 `OpenWrt` -> 